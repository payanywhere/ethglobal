substitutions:
  _PROJECT_ID: payanywhere
  _TF_STATE_BUCKET: paw-tf-state-dev
  _TF_VARS_FILE: envs/dev.tfvars
  _SA_SECRET_NAME: paw-terraform-sa-dev-key
  _TERRAFORM_DIR: infra

steps:
  # 1. Get credentials from Secret Manager
  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    entrypoint: bash
    args:
      - -c
      - |
        echo "ðŸ”¹ Getting Terraform credentials..."
        gcloud secrets versions access latest \
          --secret=${_SA_SECRET_NAME} \
          --project=${_PROJECT_ID} > /workspace/sa-key.json
        echo "âœ… Credentials obtained successfully"
    id: 'get-credentials'

  # 2. Execute Terraform
  - name: hashicorp/terraform:1.7.5
    entrypoint: sh
    args:
      - -c
      - |
        echo "ðŸ”¹ Setting up environment..."
        export GOOGLE_APPLICATION_CREDENTIALS=/workspace/sa-key.json
        
        cd ${_TERRAFORM_DIR}
        
        echo "ðŸ”¹ Initializing Terraform..."
        terraform init \
          -input=false \
          -backend-config="bucket=${_TF_STATE_BUCKET}" \
          -backend-config="prefix=terraform/state"
        
        echo "ðŸ”¹ Validating configuration..."
        terraform validate -no-color
        
        echo "ðŸ”¹ Generating execution plan..."
        terraform plan \
          -input=false \
          -var-file="${_TF_VARS_FILE}" \
          -out=tfplan
          
        echo "ðŸ”¹ Showing changes..."
        terraform show -no-color tfplan
        
        echo "ðŸš€ Applying changes..."
        terraform apply -input=false -auto-approve tfplan
        
        echo "âœ… Infrastructure deployed successfully"
    id: 'terraform-apply'

timeout: 1200s
options:
  logging: CLOUD_LOGGING_ONLY